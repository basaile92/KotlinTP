#! /usr/bin/env bash

DIR="/tmp"
DOWNLOAD_LINK="https://download.jetbrains.com/idea/ideaIC-2017.2.5-no-jdk.tar.gz"

APP_NAME="idea-IC-172.4343.14"
PKG_NAME="ideaIC-2017.2.5-no-jdk.tar.gz"
SHA256_LINK="https://download.jetbrains.com/idea/ideaIC-2017.2.5-no-jdk.tar.gz.sha256"
SHA_NAME=$PKG_NAME.sha256
LOCAL="/local/$USER"

_GREEN='\033[0;32m'
_RED='\033[0;31m'
_YELLOW='\033[1;33m'
_CYAN='\033[0;36m'
_END='\033[0;0m'

function mecho {
    if [[ $# -gt 1 ]]
    then
	echo -e ${2}$1${_END}
    else
	echo $1
    fi
}

function xecho {
    mecho $1 $_RED
    rm -f $DIR/$PKG_NAME
    rm -f $DIR/$SHA_NAME
    exit 1
}

IDEA_PATH=$(which idea.sh || which idea)
if [ $? = 0 ]
then
    mecho "Already installed" $_GREEN
    mecho "$IDEA_PATH" $_YELLOW
    exit 0
elif [[ -d $LOCAL/idea/ ]]
then
    mecho "Already installed" $_GREEN
    mecho "$LOCAL/idea/bin/idea.sh" $_YELLOW
    exit 0
elif [[ -f "$DIR/$APP_NAME/bin/idea.sh" ]]
then
    mecho "Already installed" $_GREEN
    mecho "$DIR/$APP_NAME/bin/idea.sh" $_YELLOW
    exit 0
else
    mecho "Installing $PKG_NAME" $_GREEN
fi



mecho "Working in $DIR"
cd $DIR

mecho "Retrieving sha256" $_GREEN
rm -f "$SHA_NAME"
wget $SHA256_LINK

mecho "Checking if package already downloaded" $_GREEN
sha256sum -c $SHA_NAME 1>/dev/null 2>/dev/null

if [ $? -ne 0 ]
then
    mecho "Downloading package $PKG_NAME" $_GREEN
    rm -f $PKG_NAME
    wget $DOWNLOAD_LINK
    mecho "Checking sha256" $_GREEN
    sha256sum -c $SHA_NAME 2>/dev/null || xecho "Something went wrong!"
else
    mecho "Package already downloaded" $_GREEN
fi

## from now the package is installed in /tmp/$PKG_NAME

mecho "Extracting $PKG_NAME"
tar xvfz $PKG_NAME

[[ $? -ne 0 ]] && xecho "Something went wrong while extracting"

echo -en ${_GREEN}"Do you wish to install the package in $LOCAL ? [Y/n]:"${_END}
read response

if [[ ${response:-"Y"} = "Y" ]]
then
    mv -v $APP_NAME $LOCAL/idea
    mecho "Installed in $LOCAL/idea/" $_GREEN
    mecho "You should add the next line to your ~/.bashrc"
    mecho "PATH=$PATH:$LOCAL/idea/bin"
    mecho "$LOCAL/idea/bin/idea.sh" $_YELLOW
else
    mecho "$DIR/$APP_NAME/bin/idea.sh" $_YELLOW
fi
